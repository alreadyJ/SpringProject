<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.split.first.repository.ListRepository">

    <resultMap id="saleResultMap" type="com.split.first.dto.Sale">
        <id property="serial" column="serial" />
        <collection property="user" resultMap="userResultMap"/>
        <result property="title" column="title"/>
        <result property="category" column="category"/>
        <result property="detail" column="detail"/>
        <result property="location" column="location"/>
        <result property="registeredDate" column="registered_date"/>
        <result property="expiration" column="expiration"/>
        <result property="quantity" column="quantity"/>
        <result property="remainQuantity" column="remain_quantity"/>
        <result property="maxPurchase" column="max_purchase"/>
        <result property="price" column="price"/>
        <result property="status" column="status"/>
        <collection property="saleImage" javaType="java.util.ArrayList" resultMap="imageResultMap"/>
    </resultMap>

    <resultMap id="userResultMap" type="com.split.first.dto.User">
        <id property="serial" column="user_serial" />
        <result property="email" column="password"/>
        <result property="password" column="password"/>
        <result property="nickName" column="nick_name"/>
        <result property="phone" column="phone"/>
        <result property="profileImage" column="profile_image"/>
        <result property="signUpDate" column="sign_up_date"/>
        <result property="address" column="address"/>
    </resultMap>

    <resultMap id="imageResultMap" type="com.split.first.dto.Image">
        <id property="serial" column="serial"/>
        <result property="uri" column="uri"/>
    </resultMap>


    <select id="selectSalesAndUser" resultMap="salesAndUser">
        SELECT S.*, I.serial as image_serial, I.uri
        FROM
        (SELECT S.serial, U.serial as user_serial, U.email, U.password, U.nick_name,
            U.phone, U.profile_image, U.sign_up_date, U.address,
            U.country, U.description, S.title, S.category, S.detail,
            S.location, S.registered_date, S.expiration, S.quantity,
            S.remain_quantity, S.max_purchase,S.price, S.status
        FROM sale S
        INNER JOIN user U
        ON S.user_serial = U.serial
        ORDER BY S.serial DESC
        LIMIT 12) S
        LEFT JOIN sale_image I
        ON S.serial = sale_image.serial AND S.status = '0'
        ORDER BY S.serial DESC
    </select>

    <select id="selectSaleCategory" parameterType="java.util.HashMap" resultType="com.split.first.dto.Sale">
            SELECT *
            FROM sale
            WHERE status = '0' AND category = #{category}
            ORDER BY serial DESC
    </select>

    <select id="selectOneSale" parameterType="java.util.HashMap" resultType="com.split.first.dto.Sale">
            SELECT *
            FROM sale
            WHERE status = '0' AND serial = #{serial}
    </select>

    <select id="selectTrips" parameterType="java.util.HashMap" resultType="com.split.first.dto.Trip">
            SELECT *
            FROM trip
            WHERE status = '0'
            ORDER BY serial DESC
    </select>

    <select id="selectTripCategory" parameterType="java.util.HashMap" resultType="com.split.first.dto.Trip">
            SELECT * FROM trip
            WHERE status = '0' AND category = #{category}
            ORDER BY serial DESC
    </select>

    <select id="selectOneTrip" parameterType="java.util.HashMap" resultType="hashmap">
            SELECT *
            FROM trip
            WHERE status = '0' AND serial = #{serial}
    </select>


    <resultMap id="requestResultMap" type="com.split.first.dto.Request">
        <id property="serial" column="serial" />
        <result property="user" column="user"/>
        <result property="title" column="title"/>
        <result property="category" column="category"/>
        <result property="detail" column="detail"/>
        <result property="location" column="location"/>
        <result property="registeredDate" column="registered_date"/>
        <result property="expiration" column="expiration"/>
        <result property="quantity" column="quantity"/>
        <result property="price" column="price"/>
        <result property="serviceFee" column="service_fee"/>
        <collection property="requestImage" javaType="java.util.ArrayList" resultMap="requestImageResultMap"/>
    </resultMap>

    <resultMap id="ImageResultMap" type="com.split.first.dto.Image">
        <id property="serial" column="serial"/>
        <result property="uri" column="uri"/>
    </resultMap>


    <select id="selectRequests" parameterType="java.util.HashMap" resultMap="requestResultMap">
            SELECT *
            FROM request
            WHERE status = '0'
            ORDER BY serial DESC
    </select>

    <select id="selectRequestCategory" parameterType="java.util.HashMap" resultType="hashmap">
            SELECT *
            FROM request
            WHERE status = '0' AND category = #{category}
            ORDER BY serial DESC
    </select>

    <select id="selectOneRequest" parameterType="java.util.HashMap" resultType="hashmap">
            SELECT *
            FROM request
            WHERE status = '0' AND serial = #{serial}
    </select>

    <insert id="insertComment" parameterType="java.util.HashMap">
        INSERT INTO comments (userSerial, itemSerial, text, registeredDate, type)
        VALUES (#{userSerial}, #{itemSerial}, #{text}, #{registerDate}, #{type})
    </insert>

    <delete id="deleteComment" parameterType="java.util.HashMap">
        DELETE FROM comments
        WHERE type = #{type} AND itemSerial = #{itemSerial} AND
        userSerial = #{userSerial} AND serial = #{serial}
    </delete>

    <select id="selectComment" parameterType="java.util.HashMap" resultType="hashmap">
        SELECT *
        FROM comments
        WHERE type = #{type} AND itemSerial = #{itemSerial}
        ORDER BY serial
    </select>

    <!--게시글 업로드 관련-->
    <insert id="insertSale" parameterType="java.util.HashMap">
        INSERT INTO sale (user, title, category, detail, location,
                          registered_date,expiration, quantity, remain_quantity,
            max_purchase, price, status)
        VALUES (#{user}, #{title}, #{category}, #{detail}, #{location},
            #{registerDate}, #{expiration}, #{quantity}, #{remainQuantity},
            #{maxPurchase}, #{price}, '0')
    </insert>

    <insert id="insertSaleImage" parameterType="java.util.HashMap">
        INSERT INTO sale_image ( serial, uri)
        VALUES ( (SELECT serial FROM sale
            WHERE registered_date = #{registerDate}
            AND title = #{title}
            LIMIT 1), #{imagePath}
        )
    </insert>



    <insert id="insertRequest" parameterType="java.util.HashMap">
        INSERT INTO request (user, title, category, detail,
            location, registered_date, expiration, quantity, price,
            service_fee, status)
        VALUES ( #{user}, #{title}, #{category}, #{detail}, #{location},
            #{registerDate}, #{expiration}, #{quantity}, #{price}, #{serviceFee}, '0')
    </insert>

    <insert id="insertRequestImage" parameterType="java.util.HashMap">
        INSERT INTO request_image (serial, uri)
        VALUES ( (SELECT serial
            FROM request
            WHERE registerDate = #{registerDate}
            AND title = #{title}
            LIMIT 1), #{imagePath}
        )
    </insert>

    <insert id="insertTrip" parameterType="java.util.HashMap">
        INSERT INTO trip (user, source, destination, is_round,
            purpose, departure_date, arrival_date,
            registered_date, schedule, location, status
        )
        VALUES (#{user}, #{source}, #{destination}, #{isRound},
            #{purpose}, #{departureDate}, #{arrivalDate},
            #{registerDate}, #{schedule}, #{location}, '0'
        )
    </insert>




</mapper>